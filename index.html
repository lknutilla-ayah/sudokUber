<!DOCTYPE html>
<head>
    <title>SudokUber</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
</head>
<body onload = "createSudoku()">
    <div id="wrapper">
    <!-- start html block -->
        <header>
            <h1>SudokUber</h1>
        </header>
        <nav></nav>
        <section class="content">
            <div id = "sudokuBoard">
                <section>
                    <table id = "sudokuTable">
                    </table>
                </section>
            </div>
        </section>
        <aside class="sidebar">
            <div id = "timer">00:00</div>
            <button onclick="fillBoard(); startClock();">New Game</button></br>
            <button id = "done" type = "submit" onclick = "checkBoard()">Done!</button></br>
            <h2>Rules</h2>
            <p>The Classic Sudoku is a number placing puzzle based on a 9x9 grid with several given numbers. The object is to place the numbers 1 to 9 in the empty squares so that each row, each column and each 3x3 box contains the same number only once.</p>
            <p>Rules from <a href="http://www.conceptispuzzles.com/?uri=puzzle/sudoku/rules" target="_blank"> Conceptis Puzzles</a></p>
        </aside>
        <footer></footer>
    <!-- end html block -->
    </div>

    <script type="text/javascript">
        var clicked = false;
        var sec,min;
        function startClock() {
            sec = 0;
            min = 0;
            if (clicked === false) {
                clock = setInterval("stopWatch()", 1000);
                clicked = true;
            }
            else if (clicked === true) {
            }
        }

        function stopWatch() {
            if (sec === 60) {
                ++min;
                sec = 0;
            }
            sec++;
            document.getElementById("timer").innerHTML = convertToTime(min) + ":" + convertToTime(sec);
        }
        function convertToTime(time){
            if (time > 9) return time;
            else return "0"+time;
        }

        function stopClock() {
            window.clearInterval(clock);
            sec = 0;
            document.getElementById("timer").innerHTML="00:00";
            clicked = false;
        }
        function createSudoku() {
            var check = document.getElementsByClassName("cell");
            if (check.length != 0) {
                fillBoard(check); 
                return;
            }
            var body=document.getElementsByTagName('body')[0];
            var board=document.getElementById('sudokuTable');
            var boardbdy=document.createElement('tbody');
            for(var i = 0; i < 9; ++i){
                var row=document.createElement('tr');
                for(var j = 0; j < 9; ++j){
                    var td=document.createElement('td');
                    var numb = document.createElement("input");
                    numb.className += "cell";
                    var block;
                    if (i < 3 && j < 3) {
                        block = 'a';
                        numb.className += " grey_block";
                    }
                    else if (i < 3 && j < 6) block = 'b';
                    else if (i < 3 && j > 5) {
                        block = 'c';
                        numb.className += " grey_block";
                    }
                    else if (i < 6 && j < 3) block = 'd';
                    else if (i < 6 && j < 6) {
                        block = 'e';
                        numb.className += " grey_block";
                    }
                    else if (i < 6 && j > 5) block = 'f';
                    else if (i > 5 && j < 3) {
                        block = 'g';
                        numb.className += " grey_block";
                    }
                    else if (i > 5 && j < 6) block = 'h';
                    else {
                        block = 'i';
                        numb.className += " grey_block";
                    }
                    numbID = [i, j, block];
                    numb.id += numbID.join('');
                    td.appendChild(numb);
                    row.appendChild(td)
                }
                boardbdy.appendChild(row);
            }
            board.appendChild(boardbdy);
            body.appendChild(board);
        };

        function fillBoard() {
            var board = document.getElementsByClassName("cell");
            var randomNine = fishYatesShuffle(9);
            //create sudoku board
            for (var i = 0; i < 9; i++) {
                for (var j = 0; j < 9; j++) {
                    board[i * 9 + j].value = (i * 3 + Math.floor(i/3) + j) % 9 + 1;
                    board[i * 9 + j].readOnly = true;
                    board[i * 9 + j].style.color = "black";
                }
            }
            //switch corresponding col
            for (var i = 0; i < 20; ++i) {
                var col = Math.floor(Math.random() * 3);
                do {
                    var swap = col + (Math.floor(Math.random() * 3) * 3);// + 0, +3, +6
                }while(swap === 0)
                for (var j = 0; j < 9; ++j) {
                    var tmp = board[col + (j*9)].value;
                    board[col + (j*9)].value = board[swap + (j*9)].value;
                    board[swap + (j*9)].value = tmp;
                }
            }
            //switch cols in section blocks
            for (var i = 0; i < 20; ++i) {
                var block = Math.floor(Math.random() * 3);
                do {
                    var swap1 = Math.floor(Math.random() * 3) + block*3;
                    var swap2 = Math.floor(Math.random() * 3) + block*3;
                }while(swap1 === swap2)
                for (var j = 0; j < 9; ++j) {
                    var tmp = board[swap1 + (j*9)].value;
                    board[swap1 + (j*9)].value = board[swap2 + (j*9)].value;
                    board[swap2 + (j*9)].value = tmp;
                }
            }
            //switch rows in section blocks
            for (var i = 0; i < 20; ++i) {
                var block = Math.floor(Math.random() * 3);
                do {
                    var swap1 = Math.floor(Math.random() * 3) * 9 + block * 27;
                    var swap2 = Math.floor(Math.random() * 3) * 9 + block * 27;
                }while(swap1 === swap2)
                for (var j = 0; j < 9; ++j) {
                    var tmp = board[swap1 + j].value;
                    board[swap1 + j].value = board[swap2 + j].value;
                    board[swap2 + j].value = tmp;
                }
            }
            //switch numbers
            for (var i = 0; i < 20; ++i) {
                do {
                    var numb1 = Math.ceil(Math.random() * 9);
                    var numb2 = Math.ceil(Math.random() * 9);
                }while(numb1 === numb2)
                for (var j = 0; j < board.length; ++j) {
                    if (board[j].value === numb1) board[j].value = numb2;
                    else if (board[j].value === numb2) board[j].value = numb1;
                }
            }
            hideCells();

         };
        function hideCells() {
            //naiivly hide 5 squares/block
            var board = document.getElementsByClassName("cell");
            var block = fishYatesShuffle(9);
            for (var i = 0; i < 9; ++i) {
                var cells = fishYatesShuffle(9);
                var cur_block = block.pop();
                for (var j = 0; j < 4; ++ j) {
                    var cell = cells.pop() + cur_block * 9;
                    board[cell].readOnly = false;
                    board[cell].onblur = function(event) { checkValid(this); };
                    board[cell].value = "";
                }
            }
        } 
        function fishYatesShuffle(size) {
            var fishYatesArray = [];
            for (var i = 0; i < size; i++) {
                fishYatesArray.push(i);
            }
            for (var j = size - 1; j >= 0; --j) {
                var k = Math.floor(Math.random() * (j+1));
                var cell1 = fishYatesArray[j];
                var cell2 = fishYatesArray[k];
                fishYatesArray[j] = cell2;
                fishYatesArray[k] = cell1;
            }
            return fishYatesArray;
        }

        function checkValid(numb) {
            var valid = true;
            if(numb.value != "") {
                if (numb.value % 1 != 0 || numb.value > 9 || numb.value < 1) {
                    alert("Invalid Entry: Please enter a number between 1 - 9. You entered " + numb.value);
                }
            }
            var board = document.getElementsByClassName("cell");
            var check = document.getElementById(numb.id);
            check = check.id.split("");
            for (var i = 0; i < board.length; ++i) {
                var boardId = board[i].id;
                boardId = boardId.split("");
                var row = boardId[0];
                var col = boardId[1];
                var block = boardId[2];
                if (row === check[0] && col === check[1]) continue;
                if (row === check[0] || col === check[1] || block === check[2]) {
                    if (numb.value === board[i].value && numb.value != "") {
                        valid = false;
                        document.getElementById(numb.id).style.color = "red";
                        document.getElementById(board[i].id).style.color = "red";
                    }
                    else {
                        document.getElementById(board[i].id).style.color = "black";
                        if (valid) document.getElementById(numb.id).style.color = "black";
                    }
                }
            }
            return valid;
        };
        function checkBoard() {
            var board = document.getElementsByClassName("cell");
            var valid = true;
            for (var i = 0; i < board.length; ++i) {
                var checkId = board[i].id;
                checkId = checkId.split("");
                var rowC = checkId[0];
                var colC = checkId[1];
                var blockC = checkId[2];
                for (var j = i; j < board.length; ++j) {
                    var boardId = board[j].id;
                    boardId = boardId.split("");
                    var rowB = boardId[0];
                    var colB = boardId[1];
                    var blockB = boardId[2];
                    if (board[i].value === "") {
                        valid = false;
                    }
                    if (rowC === rowB && colC === colB) continue;
                    if (rowC === rowB || colC === colB || blockC === blockB) {
                        if (board[j].value === board[i].value) {
                            valid = false;
                            document.getElementById(board[j].id).style.color = "red";
                            document.getElementById(board[i].id).style.color = "red";
                        }
                        else if (valid) {
                            document.getElementById(board[j].id).style.color = "black";
                            document.getElementById(board[i].id).style.color = "black";
                        }
                    }
                }
            }
            if (valid) {
               stopClock(); 
               console.log("Good");
            } 
        }

    </script>
</body>
</html>
